<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Evaluación de Competencias en UCI</title>
    <style>
        /* CSS Reset & Base Styles */
        :root {
            --bg-primary: #f3f4f6; --bg-secondary: #ffffff; --bg-tertiary: #e5e7eb;
            --text-primary: #111827; --text-secondary: #4b5563; --text-accent: #1d4ed8;
            --border-color: #d1d5db; --accent-color: #3b82f6; --accent-hover: #2563eb;
            --danger-color: #ef4444;
        }
        html.dark {
            --bg-primary: #111827; --bg-secondary: #1f2937; --bg-tertiary: #374151;
            --text-primary: #f9fafb; --text-secondary: #d1d5db; --text-accent: #60a5fa;
            --border-color: #4b5563; --accent-color: #3b82f6; --accent-hover: #60a5fa;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: var(--bg-primary); color: var(--text-primary); transition: background-color 0.3s, color 0.3s; line-height: 1.6; }
        .hidden { display: none !important; }

        /* App Layout */
        .container { max-width: 1200px; margin: 2rem auto; padding: 1rem; }
        .view { background-color: var(--bg-secondary); border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); padding: 2rem; }
        .view-header { text-align: center; margin-bottom: 2rem; }
        .view-header h1 { font-size: 2rem; font-weight: 800; color: var(--text-accent); }
        .view-header p { font-size: 1.1rem; color: var(--text-secondary); margin-top: 0.5rem; }

        /* Components */
        .btn { padding: 0.75rem 1.5rem; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; transition: all 0.2s; text-decoration: none; display: inline-flex; align-items: center; gap: 0.5rem; }
        .btn-primary { background-color: var(--accent-color); color: white; }
        .btn-primary:hover { background-color: var(--accent-hover); }
        .btn-secondary { background-color: var(--bg-tertiary); color: var(--text-primary); }
        .btn-secondary:hover { background-color: var(--border-color); }
        .btn-danger { background-color: var(--danger-color); color: white; }
        
        .form-group { margin-bottom: 1.5rem; }
        .form-group label { display: block; font-weight: 600; margin-bottom: 0.5rem; color: var(--text-secondary); }
        .form-control { width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 6px; background-color: var(--bg-primary); color: var(--text-primary); font-size: 1rem; }
        
        /* Simulation View */
        .sim-layout { display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; }
        @media (max-width: 900px) { .sim-layout { grid-template-columns: 1fr; } }
        .case-panel, .response-panel { padding: 1.5rem; border: 1px solid var(--border-color); border-radius: 8px; }
        .case-panel h3, .response-panel h3 { font-size: 1.25rem; font-weight: 700; margin-bottom: 1rem; border-bottom: 1px solid var(--border-color); padding-bottom: 0.5rem; }

        /* Evaluation & Report View */
        .evaluation-item, .report-item { margin-bottom: 2rem; }
        .resident-answer { background-color: var(--bg-primary); border: 1px dashed var(--border-color); padding: 1rem; border-radius: 6px; margin-top: 0.5rem; font-style: italic; }
        
        .slider-group { display: flex; align-items: center; gap: 1rem; margin-top: 0.5rem; }
        .slider-group input[type="range"] { flex-grow: 1; }
        .slider-group span { font-weight: 700; color: var(--text-accent); min-width: 40px; }
        
        /* Theme Toggle */
        #theme-toggle { position: fixed; top: 1rem; right: 1rem; }

        /* Print Styles */
        @media print {
            body { background-color: white; color: black; }
            .no-print { display: none !important; }
            #report-view { box-shadow: none; padding: 0; }
            .view { box-shadow: none; padding: 0; }
            @page { size: A4; margin: 20mm; }
        }
    </style>
</head>
<body>

    <button id="theme-toggle" class="btn btn-secondary no-print">🌙</button>

    <div class="container">
        <!-- WELCOME VIEW -->
        <div id="welcome-view" class="view">
            <div class="view-header">
                <h1>Evaluación de Competencias en UCI</h1>
                <p>Manejo de Emergencias Endocrinas</p>
            </div>
            <div style="max-width: 500px; margin: 0 auto;">
                <div class="form-group">
                    <label for="residentName">Nombre del Residente</label>
                    <input type="text" id="residentName" class="form-control" placeholder="Ej: Dra. Ana Pérez">
                </div>
                <div class="form-group">
                    <label for="residentLevel">Nivel/Año de Residencia</label>
                    <input type="text" id="residentLevel" class="form-control" placeholder="Ej: R3">
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <button id="start-sim-btn" class="btn btn-primary">Iniciar Simulación como Residente</button>
                    <a href="#" id="evaluator-mode-link" style="color: var(--text-accent); cursor: pointer;">Acceder como Evaluador</a>
                </div>
            </div>
             <div class="mt-8 pt-4 border-t border-gray-300 text-center no-print">
                <h3 class="text-lg font-semibold mb-2">Gestión de Datos</h3>
                <div class="flex justify-center gap-4">
                     <button id="import-cases-btn" class="btn btn-secondary">Importar Casos (JSON)</button>
                     <input type="file" id="import-cases-input" class="hidden" accept=".json">
                     <button id="export-all-btn" class="btn btn-secondary">Exportar Evaluaciones (JSON)</button>
                     <button id="import-all-btn" class="btn btn-secondary">Importar Evaluaciones (JSON)</button>
                     <input type="file" id="import-all-input" class="hidden" accept=".json">
                </div>
            </div>
        </div>

        <!-- CASE SELECTION VIEW -->
        <div id="case-selection-view" class="view hidden">
            <div class="view-header">
                <h1 id="selection-title">Seleccionar Caso Clínico</h1>
            </div>
            <div id="case-list" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 1rem;">
                <!-- Cases will be populated by JS -->
            </div>
        </div>

        <!-- SIMULATION VIEW -->
        <div id="simulation-view" class="view hidden">
            <h1 id="sim-case-title" class="text-2xl font-bold text-center mb-6"></h1>
            <div class="sim-layout">
                <div id="sim-case-panel" class="case-panel"></div>
                <div id="sim-response-panel" class="response-panel"></div>
            </div>
            <div style="text-align: center; margin-top: 2rem;">
                <button id="submit-responses-btn" class="btn btn-primary">Finalizar y Enviar Respuestas</button>
            </div>
        </div>
        
        <!-- EVALUATION VIEW (Evaluator Mode) -->
        <div id="evaluation-view" class="view hidden">
             <div class="view-header">
                <h1>Evaluar Desempeño</h1>
                <p id="evaluation-subtitle"></p>
            </div>
            <div class="sim-layout">
                <div class="case-panel">
                    <h3>Respuestas del Residente</h3>
                    <div id="evaluation-resident-answers"></div>
                </div>
                <div class="response-panel">
                    <h3>Rúbrica de Evaluación</h3>
                    <div id="evaluation-rubric"></div>
                    <div class="form-group mt-6">
                        <label for="evaluator-feedback">Retroalimentación General</label>
                        <textarea id="evaluator-feedback" rows="5" class="form-control"></textarea>
                    </div>
                </div>
            </div>
             <div style="text-align: center; margin-top: 2rem;">
                <button id="save-evaluation-btn" class="btn btn-primary">Guardar Evaluación y Ver Reporte</button>
            </div>
        </div>

        <!-- REPORT VIEW -->
        <div id="report-view" class="view hidden">
            <div id="report-content"> <!-- This div will be printed -->
                <header class="text-center border-b-2 border-black pb-4 mb-6">
                    <h1 class="text-3xl font-bold">Informe de Evaluación de Competencias</h1>
                    <h2 class="text-xl">Manejo Crítico de Emergencias Endocrinas</h2>
                </header>
                <section class="mb-6">
                    <h3 class="text-lg font-bold border-b border-gray-400 mb-2">Información General</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0 2rem;">
                        <p><strong>Residente:</strong> <span id="report-resident-name"></span></p>
                        <p><strong>Nivel:</strong> <span id="report-resident-level"></span></p>
                        <p><strong>Caso:</strong> <span id="report-case-title"></span></p>
                        <p><strong>Fecha:</strong> <span id="report-date"></span></p>
                    </div>
                </section>
                <section class="mb-6">
                    <h3 class="text-lg font-bold border-b border-gray-400 mb-2">Resultados de Evaluación</h3>
                    <div style="text-align:center; margin: 2rem 0;">
                        <p class="text-lg">Calificación Final Ponderada</p>
                        <p id="report-final-score" class="text-6xl font-black text-blue-700"></p>
                        <p id="report-performance-level" class="text-xl font-bold"></p>
                    </div>
                    <table class="w-full text-sm border-collapse border" style="page-break-inside: auto;">
                        <thead><tr class="bg-gray-200"><th class="border p-2 text-left">Competencia</th><th class="border p-2 text-left">Respuestas Clave del Residente</th><th class="border p-2 text-center">Puntaje</th></tr></thead>
                        <tbody id="report-table-body"></tbody>
                    </table>
                </section>
                <section class="mb-6" style="page-break-before: auto;">
                    <h3 class="text-lg font-bold border-b border-gray-400 mb-2">Retroalimentación del Evaluador</h3>
                    <div id="report-feedback" class="p-4 bg-gray-100 rounded"></div>
                </section>
            </div>
            <div class="text-center mt-8 no-print">
                <button onclick="window.print()" class="btn btn-primary">Descargar PDF</button>
                <button id="send-to-gas-btn" class="btn btn-primary">Generar PDF y Enviar a Drive</button>
                <span id="send-status" class="no-print" style="margin-left:8px;color:var(--text-secondary);"></span>
                <button id="export-json-btn" class="btn btn-secondary">Exportar JSON</button>
                <button id="export-csv-btn" class="btn btn-secondary">Exportar CSV</button>
                <button id="back-to-welcome-btn" class="btn btn-secondary">Volver al Inicio</button>
            </div>
        </div>
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {

    // --- 1. CONFIGURACIÓN CENTRAL ---
    const CONFIG = {
        evaluatorPassword: "UCI2024",
        rubrics: {
            // Define las competencias a evaluar. Estas se aplicarán a las preguntas del caso.
            competencies: [
                { id: 'dx', name: "Razonamiento Diagnóstico y Fisiopatológico", weight: 0.30 },
                { id: 'tx', name: "Toma de Decisiones Terapéuticas", weight: 0.40 },
                { id: 'mon', name: "Monitorización y Prevención de Complicaciones", weight: 0.20 }
            ],
            // Define los niveles de desempeño basados en el puntaje final
            performanceLevels: [
                { threshold: 90, level: "Experto", color: "#16a34a" },
                { threshold: 70, level: "Competente", color: "#2563eb" },
                { threshold: 50, level: "En Desarrollo", color: "#f59e0b" },
                { threshold: 0, level: "Novato", color: "#ef4444" }
            ]
        }
    };

    // URL del Web App de Google Apps Script (pégalo aquí cuando lo tengas desplegado)
    const GAS_URL = 'https://script.google.com/macros/s/AKfycbxcSW9ab8b5ErUCqxrfEA2LLLOf2NNkVKlnahjykZPt2D2270Xah38tjexHyLMYGHSe/exec';

    // --- 2. GESTIÓN DE CASOS ---
    let cases = [
        // CASOS DE EJEMPLO
        {
            id: "EDKA_SGLT2_01",
            title: "EDKA por Inhibidor SGLT-2 y Sepsis",
            scenario: `<h4>Presentación del Paciente</h4><p>Mujer de 50 años, ex-fumadora, con antecedentes de HTA, dislipidemia, cáncer de mama (tratado), hipotiroidismo y Diabetes Mellitus tipo 2. Su tratamiento actual incluye <strong>Dapagliflozina 10mg/día</strong>, Metformina e insulina NPH.</p><p>Ingresa por dolor abdominal, diarrea y fiebre. Al examen, está alerta, taquipneica, con dolor abdominal difuso. Un ultrasonido abdominal muestra colelitiasis múltiple.</p><h4 class='font-bold mt-4'>Resultados de Laboratorio al Ingreso a UCI:</h4><table class='w-full text-sm mt-2'><thead style='background-color: var(--bg-tertiary);'><tr><th class='p-2 text-left'>Parámetro</th><th class='p-2 text-right'>Valor</th></tr></thead><tbody><tr style='border-bottom: 1px solid var(--border-color);'><td class='p-2 font-medium'>Glucosa</td><td class='p-2 text-right font-bold'>165 mg/dL</td></tr><tr style='border-bottom: 1px solid var(--border-color);'><td class='p-2 font-medium'>pH</td><td class='p-2 text-right font-bold text-red-500'>7.13</td></tr><tr style='border-bottom: 1px solid var(--border-color);'><td class='p-2 font-medium'>Bicarbonato (HCO3)
