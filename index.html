<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Evaluaci√≥n de Competencias en UCI</title>
    <style>
        /* CSS Reset & Base Styles */
        :root {
            --bg-primary: #f3f4f6; --bg-secondary: #ffffff; --bg-tertiary: #e5e7eb;
            --text-primary: #111827; --text-secondary: #4b5563; --text-accent: #1d4ed8;
            --border-color: #d1d5db; --accent-color: #3b82f6; --accent-hover: #2563eb;
            --danger-color: #ef4444;
        }
        html.dark {
            --bg-primary: #111827; --bg-secondary: #1f2937; --bg-tertiary: #374151;
            --text-primary: #f9fafb; --text-secondary: #d1d5db; --text-accent: #60a5fa;
            --border-color: #4b5563; --accent-color: #3b82f6; --accent-hover: #60a5fa;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: var(--bg-primary); color: var(--text-primary); transition: background-color 0.3s, color 0.3s; line-height: 1.6; }
        .hidden { display: none !important; }

        /* App Layout */
        .container { max-width: 1200px; margin: 2rem auto; padding: 1rem; }
        .view { background-color: var(--bg-secondary); border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); padding: 2rem; }
        .view-header { text-align: center; margin-bottom: 2rem; }
        .view-header h1 { font-size: 2rem; font-weight: 800; color: var(--text-accent); }
        .view-header p { font-size: 1.1rem; color: var(--text-secondary); margin-top: 0.5rem; }

        /* Components */
        .btn { padding: 0.75rem 1.5rem; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; transition: all 0.2s; text-decoration: none; display: inline-flex; align-items: center; gap: 0.5rem; }
        .btn-primary { background-color: var(--accent-color); color: white; }
        .btn-primary:hover { background-color: var(--accent-hover); }
        .btn-secondary { background-color: var(--bg-tertiary); color: var(--text-primary); }
        .btn-secondary:hover { background-color: var(--border-color); }
        .btn-danger { background-color: var(--danger-color); color: white; }
        
        .form-group { margin-bottom: 1.5rem; }
        .form-group label { display: block; font-weight: 600; margin-bottom: 0.5rem; color: var(--text-secondary); }
        .form-control { width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 6px; background-color: var(--bg-primary); color: var(--text-primary); font-size: 1rem; }
        
        /* Simulation View */
        .sim-layout { display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; }
        @media (max-width: 900px) { .sim-layout { grid-template-columns: 1fr; } }
        .case-panel, .response-panel { padding: 1.5rem; border: 1px solid var(--border-color); border-radius: 8px; }
        .case-panel h3, .response-panel h3 { font-size: 1.25rem; font-weight: 700; margin-bottom: 1rem; border-bottom: 1px solid var(--border-color); padding-bottom: 0.5rem; }

        /* Evaluation & Report View */
        .evaluation-item, .report-item { margin-bottom: 2rem; }
        .resident-answer { background-color: var(--bg-primary); border: 1px dashed var(--border-color); padding: 1rem; border-radius: 6px; margin-top: 0.5rem; font-style: italic; }
        
        .slider-group { display: flex; align-items: center; gap: 1rem; margin-top: 0.5rem; }
        .slider-group input[type="range"] { flex-grow: 1; }
        .slider-group span { font-weight: 700; color: var(--text-accent); min-width: 40px; }
        
        /* Theme Toggle */
        #theme-toggle { position: fixed; top: 1rem; right: 1rem; }

        /* Print Styles */
        @media print {
            body { background-color: white; color: black; }
            .no-print { display: none !important; }
            #report-view { box-shadow: none; padding: 0; }
            .view { box-shadow: none; padding: 0; }
            @page { size: A4; margin: 20mm; }
        }
    </style>
</head>
<body>

    <button id="theme-toggle" class="btn btn-secondary no-print">üåô</button>

    <div class="container">
        <!-- WELCOME VIEW -->
        <div id="welcome-view" class="view">
            <div class="view-header">
                <h1>Evaluaci√≥n de Competencias en UCI</h1>
                <p>Manejo de Emergencias Endocrinas</p>
            </div>
            <div style="max-width: 500px; margin: 0 auto;">
                <div class="form-group">
                    <label for="residentName">Nombre del Residente</label>
                    <input type="text" id="residentName" class="form-control" placeholder="Ej: Dra. Ana P√©rez">
                </div>
                <div class="form-group">
                    <label for="residentLevel">Nivel/A√±o de Residencia</label>
                    <input type="text" id="residentLevel" class="form-control" placeholder="Ej: R3">
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <button id="start-sim-btn" class="btn btn-primary">Iniciar Simulaci√≥n como Residente</button>
                    <a href="#" id="evaluator-mode-link" style="color: var(--text-accent); cursor: pointer;">Acceder como Evaluador</a>
                </div>
            </div>
             <div class="mt-8 pt-4 border-t border-gray-300 text-center no-print">
                <h3 class="text-lg font-semibold mb-2">Gesti√≥n de Datos</h3>
                <div class="flex justify-center gap-4">
                     <button id="import-cases-btn" class="btn btn-secondary">Importar Casos (JSON)</button>
                     <input type="file" id="import-cases-input" class="hidden" accept=".json">
                     <button id="export-all-btn" class="btn btn-secondary">Exportar Evaluaciones (JSON)</button>
                     <button id="import-all-btn" class="btn btn-secondary">Importar Evaluaciones (JSON)</button>
                     <input type="file" id="import-all-input" class="hidden" accept=".json">
                </div>
            </div>
        </div>

        <!-- CASE SELECTION VIEW -->
        <div id="case-selection-view" class="view hidden">
            <div class="view-header">
                <h1 id="selection-title">Seleccionar Caso Cl√≠nico</h1>
            </div>
            <div id="case-list" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 1rem;">
                <!-- Cases will be populated by JS -->
            </div>
        </div>

        <!-- SIMULATION VIEW -->
        <div id="simulation-view" class="view hidden">
            <h1 id="sim-case-title" class="text-2xl font-bold text-center mb-6"></h1>
            <div class="sim-layout">
                <div id="sim-case-panel" class="case-panel"></div>
                <div id="sim-response-panel" class="response-panel"></div>
            </div>
            <div style="text-align: center; margin-top: 2rem;">
                <button id="submit-responses-btn" class="btn btn-primary">Finalizar y Enviar Respuestas</button>
            </div>
        </div>
        
        <!-- EVALUATION VIEW (Evaluator Mode) -->
        <div id="evaluation-view" class="view hidden">
             <div class="view-header">
                <h1>Evaluar Desempe√±o</h1>
                <p id="evaluation-subtitle"></p>
            </div>
            <div class="sim-layout">
                <div class="case-panel">
                    <h3>Respuestas del Residente</h3>
                    <div id="evaluation-resident-answers"></div>
                </div>
                <div class="response-panel">
                    <h3>R√∫brica de Evaluaci√≥n</h3>
                    <div id="evaluation-rubric"></div>
                    <div class="form-group mt-6">
                        <label for="evaluator-feedback">Retroalimentaci√≥n General</label>
                        <textarea id="evaluator-feedback" rows="5" class="form-control"></textarea>
                    </div>
                </div>
            </div>
             <div style="text-align: center; margin-top: 2rem;">
                <button id="save-evaluation-btn" class="btn btn-primary">Guardar Evaluaci√≥n y Ver Reporte</button>
            </div>
        </div>

        <!-- REPORT VIEW -->
        <div id="report-view" class="view hidden">
            <div id="report-content"> <!-- This div will be printed -->
                <header class="text-center border-b-2 border-black pb-4 mb-6">
                    <h1 class="text-3xl font-bold">Informe de Evaluaci√≥n de Competencias</h1>
                    <h2 class="text-xl">Manejo Cr√≠tico de Emergencias Endocrinas</h2>
                </header>
                <section class="mb-6">
                    <h3 class="text-lg font-bold border-b border-gray-400 mb-2">Informaci√≥n General</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0 2rem;">
                        <p><strong>Residente:</strong> <span id="report-resident-name"></span></p>
                        <p><strong>Nivel:</strong> <span id="report-resident-level"></span></p>
                        <p><strong>Caso:</strong> <span id="report-case-title"></span></p>
                        <p><strong>Fecha:</strong> <span id="report-date"></span></p>
                    </div>
                </section>
                <section class="mb-6">
                    <h3 class="text-lg font-bold border-b border-gray-400 mb-2">Resultados de Evaluaci√≥n</h3>
                    <div style="text-align:center; margin: 2rem 0;">
                        <p class="text-lg">Calificaci√≥n Final Ponderada</p>
                        <p id="report-final-score" class="text-6xl font-black text-blue-700"></p>
                        <p id="report-performance-level" class="text-xl font-bold"></p>
                    </div>
                    <table class="w-full text-sm border-collapse border" style="page-break-inside: auto;">
                        <thead><tr class="bg-gray-200"><th class="border p-2 text-left">Competencia</th><th class="border p-2 text-left">Respuestas Clave del Residente</th><th class="border p-2 text-center">Puntaje</th></tr></thead>
                        <tbody id="report-table-body"></tbody>
                    </table>
                </section>
                <section class="mb-6" style="page-break-before: auto;">
                    <h3 class="text-lg font-bold border-b border-gray-400 mb-2">Retroalimentaci√≥n del Evaluador</h3>
                    <div id="report-feedback" class="p-4 bg-gray-100 rounded"></div>
                </section>
            </div>
            <div class="text-center mt-8 no-print">
                <button onclick="window.print()" class="btn btn-primary">Descargar PDF</button>
                <button id="send-to-gas-btn" class="btn btn-primary">Generar PDF y Enviar a Drive</button>
                <span id="send-status" class="no-print" style="margin-left:8px;color:var(--text-secondary);"></span>
                <button id="export-json-btn" class="btn btn-secondary">Exportar JSON</button>
                <button id="export-csv-btn" class="btn btn-secondary">Exportar CSV</button>
                <button id="back-to-welcome-btn" class="btn btn-secondary">Volver al Inicio</button>
            </div>
        </div>
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {

    // --- 1. CONFIGURACI√ìN CENTRAL ---
    const CONFIG = {
        evaluatorPassword: "UCI2024",
        rubrics: {
            // Define las competencias a evaluar. Estas se aplicar√°n a las preguntas del caso.
            competencies: [
                { id: 'dx', name: "Razonamiento Diagn√≥stico y Fisiopatol√≥gico", weight: 0.30 },
                { id: 'tx', name: "Toma de Decisiones Terap√©uticas", weight: 0.40 },
                { id: 'mon', name: "Monitorizaci√≥n y Prevenci√≥n de Complicaciones", weight: 0.20 }
            ],
            // Define los niveles de desempe√±o basados en el puntaje final
            performanceLevels: [
                { threshold: 90, level: "Experto", color: "#16a34a" },
                { threshold: 70, level: "Competente", color: "#2563eb" },
                { threshold: 50, level: "En Desarrollo", color: "#f59e0b" },
                { threshold: 0, level: "Novato", color: "#ef4444" }
            ]
        }
    };

    // URL del Web App de Google Apps Script (p√©galo aqu√≠ cuando lo tengas desplegado)
    const GAS_URL = 'https://script.google.com/macros/s/AKfycbxcSW9ab8b5ErUCqxrfEA2LLLOf2NNkVKlnahjykZPt2D2270Xah38tjexHyLMYGHSe/exec';

    // --- 2. GESTI√ìN DE CASOS ---
    let cases = [
        // CASOS DE EJEMPLO
        {
            id: "EDKA_SGLT2_01",
            title: "EDKA por Inhibidor SGLT-2 y Sepsis",
            scenario: `<h4>Presentaci√≥n del Paciente</h4><p>Mujer de 50 a√±os, ex-fumadora, con antecedentes de HTA, dislipidemia, c√°ncer de mama (tratado), hipotiroidismo y Diabetes Mellitus tipo 2. Su tratamiento actual incluye <strong>Dapagliflozina 10mg/d√≠a</strong>, Metformina e insulina NPH.</p><p>Ingresa por dolor abdominal, diarrea y fiebre. Al examen, est√° alerta, taquipneica, con dolor abdominal difuso. Un ultrasonido abdominal muestra colelitiasis m√∫ltiple.</p><h4 class='font-bold mt-4'>Resultados de Laboratorio al Ingreso a UCI:</h4><table class='w-full text-sm mt-2'><thead style='background-color: var(--bg-tertiary);'><tr><th class='p-2 text-left'>Par√°metro</th><th class='p-2 text-right'>Valor</th></tr></thead><tbody><tr style='border-bottom: 1px solid var(--border-color);'><td class='p-2 font-medium'>Glucosa</td><td class='p-2 text-right font-bold'>165 mg/dL</td></tr><tr style='border-bottom: 1px solid var(--border-color);'><td class='p-2 font-medium'>pH</td><td class='p-2 text-right font-bold text-red-500'>7.13</td></tr><tr style='border-bottom: 1px solid var(--border-color);'><td class='p-2 font-medium'>Bicarbonato (HCO3)</td><td class='p-2 text-right font-bold text-red-500'>2 mEq/L</td></tr><tr style='border-bottom: 1px solid var(--border-color);'><td class='p-2 font-medium'>Anion Gap</td><td class='p-2 text-right font-bold text-red-500'>32</td></tr><tr style='border-bottom: 1px solid var(--border-color);'><td class='p-2 font-medium'>Potasio (K+)</td><td class='p-2 text-right'>3.9 mEq/L</td></tr><tr style='border-bottom: 1px solid var(--border-color);'><td class='p-2 font-medium'>Cetonemia</td><td class='p-2 text-right'>Positiva</td></tr></tbody></table><p class='mt-4'>El paciente es admitido en la UCI con un diagn√≥stico de <strong>Sepsis de origen biliar</strong>. Su tarea es analizar la situaci√≥n metab√≥lica y definir el plan de manejo completo.</p>`,
            questions: [
                {
                    id: "q1",
                    competencyId: "dx",
                    prompt: "An√°lisis del Problema: A pesar de una glucosa casi normal, el paciente tiene una acidosis metab√≥lica severa con ani√≥n gap elevado. ¬øCu√°l es el diagn√≥stico metab√≥lico preciso y qu√© f√°rmaco es el principal factor causal?",
                    type: "textarea",
                    placeholder: "Diagn√≥stico metab√≥lico: ...\nF√°rmaco causal principal: ..."
                },
                {
                    id: "q2",
                    competencyId: "tx",
                    prompt: "Plan Terap√©utico Inmediato: Enumere las 3 acciones farmacol√≥gicas y no farmacol√≥gicas m√°s importantes que debe ejecutar AHORA para tratar la EDKA (adem√°s del manejo de la sepsis).",
                    type: "textarea",
                    placeholder: "1. Suspender inmediatamente...\n2. Iniciar infusi√≥n de...\n3. Iniciar fluidoterapia con..."
                },
                {
                    id: "q3",
                    competencyId: "mon",
                    prompt: "Monitorizaci√≥n y Prevenci√≥n: Al iniciar la infusi√≥n de insulina, ¬øqu√© dos par√°metros de laboratorio debe monitorizar de forma horaria o bi-horaria para prevenir complicaciones iatrog√©nicas graves? Explique brevemente por qu√©.",
                    type: "textarea",
                    placeholder: "Par√°metro 1 y su justificaci√≥n...\nPar√°metro 2 y su justificaci√≥n..."
                },
                {
                    id: "q4",
                    competencyId: "dx",
                    prompt: "Razonamiento Fisiopatol√≥gico: Explique brevemente el mecanismo por el cual el inhibidor de SGLT-2 contribuy√≥ a esta cetoacidosis con glucosa normal.",
                    type: "textarea",
                    placeholder: "El f√°rmaco causa glucosuria, lo que lleva a un estado de d√©ficit relativo de insulina/exceso de glucag√≥n y promueve la cetog√©nesis a pesar de..."
                }
            ]
        },
        {
            id: "THYROID_STORM_COMA_01",
            title: "Tormenta Tiroidea con presentaci√≥n en Coma",
            scenario: `<h4>Presentaci√≥n del Paciente</h4><p>Mujer de 32 a√±os, con antecedente de asma bien controlada, es encontrada inconsciente en casa. Es intubada en la escena por un Glasgow de 5 (O1, V1, M3).</p><p>A su llegada a emergencias, persiste taquic√°rdica y febril (39.5¬∞C), con una PA inicial de 168/102 mmHg. Se inicia manejo para un diagn√≥stico de trabajo de <strong>meningoencefalitis</strong>.</p><h4 class='font-bold mt-4'>Evoluci√≥n en las primeras horas en UCI:</h4><ul class='list-disc list-inside text-sm mt-2'><li>A pesar de la sedaci√≥n, persiste con taquicardia sinusal y fiebre.</li><li>Desarrolla <strong>hipotensi√≥n</strong> que requiere infusi√≥n de noradrenalina.</li><li>La punci√≥n lumbar y el TAC de cr√°neo son normales.</li></ul><h4 class='font-bold mt-4'>Resultados de Laboratorio Clave (7 horas post-ingreso):</h4><table class='w-full text-sm mt-2'><thead style='background-color: var(--bg-tertiary);'><tr><th class='p-2 text-left'>Par√°metro</th><th class='p-2 text-right'>Valor</th><th class='p-2 text-left'>Rango de Referencia</th></tr></thead><tbody><tr style='border-bottom: 1px solid var(--border-color);'><td class='p-2 font-medium'>TSH</td><td class='p-2 text-right font-bold text-red-500'>&lt;0.01 mU/L</td><td class='p-2'>(0.4-4.5)</td></tr><tr style='border-bottom: 1px solid var(--border-color);'><td class='p-2 font-medium'>T4 Libre</td><td class='p-2 text-right font-bold text-red-500'>53.7 pmol/L</td><td class='p-2'>(12-22)</td></tr><tr style='border-bottom: 1px solid var(--border-color);'><td class='p-2 font-medium'>T3 Libre</td><td class='p-2 text-right font-bold text-red-500'>21.6 pmol/L</td><td class='p-2'>(3.1-6.8)</td></tr></tbody></table><p class='mt-4'>Se confirma el diagn√≥stico de <strong>Tormenta Tiroidea</strong>. Su tarea es dise√±ar el plan de manejo farmacol√≥gico completo e inmediato.</p>`,
            questions: [
                { id: "q1", competencyId: "dx", prompt: "An√°lisis del Retraso Diagn√≥stico: El diagn√≥stico inicial fue meningoencefalitis. ¬øQu√© dos hallazgos cl√≠nicos clave en la presentaci√≥n inicial podr√≠an haber sugerido una crisis tiroidea y ampliado el diagn√≥stico diferencial m√°s temprano?", type: "textarea", placeholder: "1. La combinaci√≥n de taquicardia sinusal desproporcionada y...\n2. La presencia inicial de hipertensi√≥n en un paciente en shock aparente, que es at√≠pico para sepsis..." },
                { id: "q2", competencyId: "tx", prompt: "Plan Terap√©utico Multifac√©tico: Describa el manejo farmacol√≥gico completo para la tormenta tiroidea, indicando un f√°rmaco para cada uno de los 4 pilares principales del tratamiento.", type: "textarea", placeholder: "1. Bloqueo de s√≠ntesis: [F√°rmaco y dosis]\n2. Bloqueo de liberaci√≥n: [F√°rmaco y dosis]\n3. Bloqueo de efectos perif√©ricos: [F√°rmaco y dosis]\n4. Bloqueo de conversi√≥n perif√©rica: [F√°rmaco y dosis]" },
                { id: "q3", competencyId: "tx", prompt: "Secuencia Terap√©utica Cr√≠tica: Al usar un antitiroideo (ej. Propiltiouracilo) y una soluci√≥n de yodo (ej. Lugol), ¬øcu√°l es la secuencia de administraci√≥n correcta y por qu√© es fundamental seguirla?", type: "textarea", placeholder: "Se debe administrar primero... (f√°rmaco), al menos 60 minutos antes de... (f√°rmaco). La raz√≥n es para prevenir el fen√≥meno de..." },
                { id: "q4", competencyId: "mon", prompt: "Manejo de Comorbilidades: La paciente tiene asma. Aunque se us√≥ propranolol, ¬øqu√© alternativa de beta-bloqueador ser√≠a m√°s segura si el asma fuera severo o si desarrollara broncoespasmo? ¬øPor qu√©?", type: "textarea", placeholder: "Alternativa: [F√°rmaco]\nJustificaci√≥n: Su principal ventaja en este escenario es..." }
            ]
        },
        {
            id: "APOPLEXY_01",
            title: "Apoplej√≠a Hipofisaria con D√©ficit Visual Agudo",
            scenario: `<h4>Presentaci√≥n del Paciente</h4><p>Un hombre de 46 a√±os con cefalea intensa de inicio s√∫bito es tra√≠do a emergencias. Presenta n√°useas, v√≥mitos y visi√≥n borrosa. No tiene antecedentes m√©dicos conocidos.</p><p>Al examen, est√° somnoliento pero responde a est√≠mulos. PA: 90/50 mmHg, FC: 110 lpm. Se evidencia ptosis del p√°rpado derecho y oftalmoplej√≠a (par√°lisis del III par craneal). El examen de campimetr√≠a visual por confrontaci√≥n sugiere una hemianopsia bitemporal.</p><h4 class='font-bold mt-4'>Resultados de Laboratorio Iniciales:</h4><table class='w-full text-sm mt-2'><thead style='background-color: var(--bg-tertiary);'><tr><th class='p-2 text-left'>Par√°metro</th><th class='p-2 text-right'>Valor</th></tr></thead><tbody><tr style='border-bottom: 1px solid var(--border-color);'><td class='p-2 font-medium'>Sodio (Na+)</td><td class='p-2 text-right'>128 mEq/L</td></tr><tr style='border-bottom: 1px solid var(--border-color);'><td class='p-2 font-medium'>Cortisol AM</td><td class='p-2 text-right font-bold text-red-500'>3 mcg/dL (Bajo)</td></tr><tr style='border-bottom: 1px solid var(--border-color);'><td class='p-2 font-medium'>TSH</td><td class='p-2 text-right font-bold text-red-500'>0.1 mU/L (Bajo)</td></tr><tr style='border-bottom: 1px solid var(--border-color);'><td class='p-2 font-medium'>T4 Libre</td><td class='p-2 text-right'>0.7 ng/dL (Normal-bajo)</td></tr></tbody></table><p class='mt-4'>Una RM de cerebro confirma una <strong>hemorragia dentro de un macroadenoma hipofisario</strong> con compresi√≥n del quiasma √≥ptico y extensi√≥n al seno cavernoso derecho. Su tarea es establecer el plan de manejo inmediato en la UCI.</p>`,
            questions: [
                { id: "q1", competencyId: "dx", prompt: "An√°lisis y Diagn√≥stico: La combinaci√≥n de cefalea en trueno, oftalmoplej√≠a y el cortisol bajo son altamente sugestivos de apoplej√≠a hipofisaria. ¬øCu√°l es la deficiencia hormonal que representa la amenaza m√°s inmediata para la vida y por qu√©?", type: "textarea", placeholder: "La deficiencia m√°s cr√≠tica es la de... (hormona), debido a que causa un shock de tipo... (distributivo, cardiog√©nico, etc.), que no responder√° adecuadamente a los vasopresores sin el reemplazo hormonal." },
                { id: "q2", competencyId: "tx", prompt: "Manejo Hormonal de Emergencia: Describa la prescripci√≥n farmacol√≥gica inicial para corregir esta deficiencia hormonal potencialmente mortal.", type: "textarea", placeholder: "F√°rmaco: ...\nDosis de estr√©s: ... (ej. 100 mg)\nV√≠a de administraci√≥n: ..." },
                { id: "q3", competencyId: "tx", prompt: "Decisi√≥n Multidisciplinaria: El paciente tiene un d√©ficit visual agudo y progresivo. ¬øCu√°l es su recomendaci√≥n principal para el equipo de neurocirug√≠a y con qu√© urgencia?", type: "textarea", placeholder: "Mi recomendaci√≥n es proceder con... (tipo de cirug√≠a). La urgencia es... (emergente/urgente/electiva) debido al riesgo de p√©rdida visual permanente." },
                { id: "q4", competencyId: "mon", prompt: "Monitorizaci√≥n y Prevenci√≥n: Adem√°s de la monitorizaci√≥n neurol√≥gica, ¬øqu√© otra complicaci√≥n endocrina aguda podr√≠a desarrollar este paciente en las pr√≥ximas 24-48 horas, y c√≥mo la vigilar√≠a?", type: "textarea", placeholder: "Complicaci√≥n potencial: ...\nPar√°metros a vigilar estrictamente: ... y ..." }
            ]
        }
        // {{ PEGA AQU√ç TUS CASOS }}
        // INSTRUCCI√ìN: Agrega m√°s casos aqu√≠, siguiendo el mismo formato JSON.
    ];
    
    // --- 3. ESTADO DE LA APLICACI√ìN ---
    let appState = {
        currentUser: null,
        isEvaluator: false,
        currentCase: null,
        currentResponses: {},
        allEvaluations: [], // Array de todos los resultados guardados
    };

    // --- 4. SELECTORES DEL DOM ---
    const views = {
        welcome: document.getElementById('welcome-view'),
        caseSelection: document.getElementById('case-selection-view'),
        simulation: document.getElementById('simulation-view'),
        evaluation: document.getElementById('evaluation-view'),
        report: document.getElementById('report-view'),
    };
    
    // --- 5. L√ìGICA DE LA APLICACI√ìN ---
    
    function init() {
        // Cargar datos de localStorage
        const savedEvaluations = localStorage.getItem('allEvaluations');
        if (savedEvaluations) {
            appState.allEvaluations = JSON.parse(savedEvaluations);
        }
        const savedCases = localStorage.getItem('customCases');
        if (savedCases) {
            cases = JSON.parse(savedCases);
        }
        
        setupEventListeners();
        toggleTheme(localStorage.getItem('theme') === 'dark');
        navigateTo('welcome');
        console.log('[UCI App] Init ok');
    }

    function navigateTo(viewName) {
        Object.values(views).forEach(v => v.classList.add('hidden'));
        if (views[viewName]) {
            views[viewName].classList.remove('hidden');
        }
    }

    function startSimulation(residentName, residentLevel) {
        appState.currentUser = { name: residentName, level: residentLevel };
        appState.isEvaluator = false;
        document.getElementById('selection-title').textContent = `Bienvenido, ${residentName}. Seleccione un caso:`;
        renderCaseList();
        navigateTo('caseSelection');
    }
    
    function startEvaluation() {
        appState.isEvaluator = true;
        document.getElementById('selection-title').textContent = "Modo Evaluador: Seleccione una evaluaci√≥n para revisar";
        // Intentar cargar desde GAS, si no, usar localStorage
        (async () => {
            const fromGAS = await fetchSubmissionsFromGAS();
            if (fromGAS) {
                // Normalizar a estructura esperada por la app (sin evaluaci√≥n)
                appState.allEvaluations = fromGAS.map(s => ({
                    resident: s.resident,
                    caseId: s.caseId,
                    caseTitle: s.caseTitle,
                    responses: s.responses,
                    evaluation: null,
                    date: s.date,
                    submissionId: s.id
                }));
                localStorage.setItem('allEvaluations', JSON.stringify(appState.allEvaluations));
            } else {
                // fallback ya est√° en localStorage
                const saved = localStorage.getItem('allEvaluations');
                if (saved) appState.allEvaluations = JSON.parse(saved);
            }
            renderEvaluationList();
            navigateTo('caseSelection');
        })();
    }
    
    function renderCaseList() {
        const caseListEl = document.getElementById('case-list');
        caseListEl.innerHTML = '';
        cases.forEach(caseData => {
            const caseCard = document.createElement('div');
            caseCard.className = 'p-4 border rounded-lg cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-700';
            caseCard.innerHTML = `<h3 class="font-bold text-lg">${caseData.title}</h3>`;
            caseCard.onclick = () => selectCase(caseData.id);
            caseListEl.appendChild(caseCard);
        });
    }

    function selectCase(caseId) {
        appState.currentCase = cases.find(c => c.id === caseId);
        appState.currentResponses = {
            resident: appState.currentUser,
            caseId: caseId,
            caseTitle: appState.currentCase.title,
            responses: {},
            evaluation: null,
            date: new Date().toISOString(),
            submissionId: generateId()
        };
        renderSimulationView();
        navigateTo('simulation');
    }
    
    function renderSimulationView() {
        document.getElementById('sim-case-title').textContent = appState.currentCase.title;
        document.getElementById('sim-case-panel').innerHTML = `<h3>Escenario Cl√≠nico</h3>${appState.currentCase.scenario}`;
        
        const responsePanel = document.getElementById('sim-response-panel');
        responsePanel.innerHTML = '<h3>Plan de Acci√≥n y Razonamiento</h3>';
        appState.currentCase.questions.forEach(q => {
            const group = document.createElement('div');
            group.className = 'form-group';
            let inputHtml = '';
            if (q.type === 'select') {
                inputHtml = `<select id="${q.id}" class="form-control">${q.options?.map(o => `<option>${o}</option>`).join('') || ''}</select>`;
            } else if (q.type === 'textarea') {
                inputHtml = `<textarea id="${q.id}" rows="4" class="form-control" placeholder="${q.placeholder || ''}"></textarea>`;
            }
            group.innerHTML = `<label for="${q.id}">${q.prompt}</label>${inputHtml}`;
            responsePanel.appendChild(group);
        });
    }
    
    function submitResponses() {
        appState.currentCase.questions.forEach(q => {
            appState.currentResponses.responses[q.id] = {
                prompt: q.prompt,
                answer: (document.getElementById(q.id)?.value || '').trim(),
                competencyId: q.competencyId
            };
        });

        // Guardar localmente como pendiente
        appState.allEvaluations.push(appState.currentResponses);
        localStorage.setItem('allEvaluations', JSON.stringify(appState.allEvaluations));

        // Enviar a GAS (pendiente de evaluaci√≥n)
        sendResidentSubmissionToGAS(appState.currentResponses)
            .then(() => {
                alert("Respuestas enviadas. Un evaluador podr√° calificarlas m√°s tarde.");
                navigateTo('welcome');
            })
            .catch(() => {
                alert("Respuestas guardadas localmente. No se pudo enviar a la nube en este momento.");
                navigateTo('welcome');
            });
    }
    
    function renderEvaluationView(evaluationData) {
        appState.currentResponses = evaluationData; // Cargar la data para evaluar
        document.getElementById('evaluation-subtitle').textContent = `Residente: ${evaluationData.resident.name} | Caso: ${evaluationData.caseTitle}`;
        
        const answersEl = document.getElementById('evaluation-resident-answers');
        answersEl.innerHTML = '';
        Object.values(evaluationData.responses).forEach(resp => {
            answersEl.innerHTML += `<div class=\"mb-4\"><p class=\"font-semibold text-gray-500\">${resp.prompt}</p><div class=\"resident-answer\">${resp.answer}</div></div>`;
        });

        const rubricEl = document.getElementById('evaluation-rubric');
        rubricEl.innerHTML = '';
        CONFIG.rubrics.competencies.forEach(comp => {
            rubricEl.innerHTML += `
                <div class=\"evaluation-item\">
                    <label class=\"font-bold\">${comp.name} (${(comp.weight * 100).toFixed(0)}%)</label>
                    <div class=\"slider-group\">
                        <input type=\"range\" id=\"eval-${comp.id}\" min=\"0\" max=\"100\" value=\"50\" data-competency-id=\"${comp.id}\">
                        <span id=\"eval-val-${comp.id}\">50%</span>
                    </div>
                </div>`;
        });
        document.getElementById('evaluator-feedback').value = '';

        // Add event listeners for sliders
        CONFIG.rubrics.competencies.forEach(comp => {
            document.getElementById(`eval-${comp.id}`).addEventListener('input', e => {
                document.getElementById(`eval-val-${comp.id}`).textContent = `${e.target.value}%`;
            });
        });
    }

    // Reemplazo solicitado por el usuario: guardar, calcular y enviar en no-cors
    function saveEvaluation() {
        // Calcular puntajes de la r√∫brica
        const evaluationScores = {};
        CONFIG.rubrics.competencies.forEach(comp => {
            evaluationScores[comp.id] = parseInt(document.getElementById(`eval-${comp.id}`).value, 10);
        });
        // Calcular puntaje final normalizado a 0-100
        const totalWeight = CONFIG.rubrics.competencies.reduce((sum, c) => sum + (c.weight || 0), 0) || 1;
        let weightedSum = 0;
        CONFIG.rubrics.competencies.forEach(comp => {
            weightedSum += (evaluationScores[comp.id] || 0) * comp.weight;
        });
        const finalScoreNum = weightedSum / totalWeight;
        const performance = CONFIG.rubrics.performanceLevels.find(p => finalScoreNum >= p.threshold) || { level: 'N/A' };

        // Adjuntar evaluaci√≥n al objeto actual
        appState.currentResponses.evaluation = {
            scores: evaluationScores,
            feedback: document.getElementById('evaluator-feedback').value,
            finalScore: Number(finalScoreNum.toFixed(1)),
            performanceLevel: performance.level
        };

        // Guardar localmente, usando submissionId como clave
        const existingIndex = appState.allEvaluations.findIndex(e => e.submissionId === appState.currentResponses.submissionId);
        if (existingIndex > -1) {
            appState.allEvaluations[existingIndex] = appState.currentResponses;
        } else {
            appState.allEvaluations.push(appState.currentResponses);
        }
        localStorage.setItem('allEvaluations', JSON.stringify(appState.allEvaluations));

        // Enviar la evaluaci√≥n completa a Google Apps Script (respuesta opaca con no-cors)
        const btn = document.getElementById('save-evaluation-btn');
        if (btn) { btn.disabled = true; btn.textContent = 'Guardando en la Nube...'; }

        fetch(GAS_URL, {
            method: 'POST',
            mode: 'no-cors',
            body: JSON.stringify(appState.currentResponses)
        })
        .then(() => {
            alert('Evaluaci√≥n guardada y PDF generado en Google Drive.');
            renderReportView(appState.currentResponses);
            navigateTo('report');
        })
        .catch(err => {
            console.error('Error al enviar la evaluaci√≥n:', err);
            alert('Error al guardar en la nube. La evaluaci√≥n se guard√≥ localmente.');
            renderReportView(appState.currentResponses);
            navigateTo('report');
        })
        .finally(() => {
            if (btn) { btn.disabled = false; btn.textContent = 'Guardar Evaluaci√≥n y Ver Reporte'; }
        });
    }
    
    function renderReportView(data) {
        let finalScoreAccum = 0;
        const totalWeight = CONFIG.rubrics.competencies.reduce((sum, c) => sum + (c.weight || 0), 0) || 1;
        const tableBody = document.getElementById('report-table-body');
        tableBody.innerHTML = '';

        document.getElementById('report-resident-name').textContent = data.resident.name;
        document.getElementById('report-resident-level').textContent = data.resident.level;
        document.getElementById('report-case-title').textContent = data.caseTitle;
        document.getElementById('report-date').textContent = new Date(data.date).toLocaleString('es-ES');
        
        if (data.evaluation) {
            CONFIG.rubrics.competencies.forEach(comp => {
                const score = data.evaluation.scores[comp.id] || 0;
                finalScoreAccum += score * comp.weight;

                // Agrupar respuestas por competencia para el reporte
                const relevantAnswers = Object.values(data.responses)
                    .filter(r => r.competencyId === comp.id)
                    .map(r => `<strong>${r.prompt.split(':')[0]}:</strong><br><em>${r.answer}</em>`)
                    .join('<hr class=\"my-1\">');

                const row = `<tr>
                    <td class=\"border p-2\"><strong>${comp.name}</strong></td>
                    <td class=\"border p-2 text-xs\">${relevantAnswers || 'N/A'}</td>
                    <td class=\"border p-2 text-center font-bold\">${score}%</td>
                </tr>`;
                tableBody.innerHTML += row;
            });
            
            const finalScore = finalScoreAccum / totalWeight;
            const performance = CONFIG.rubrics.performanceLevels.find(p => finalScore >= p.threshold);
            document.getElementById('report-final-score').textContent = `${finalScore.toFixed(1)}%`;
            const levelEl = document.getElementById('report-performance-level');
            levelEl.textContent = performance.level;
            levelEl.style.color = performance.color;

            document.getElementById('report-feedback').textContent = data.evaluation.feedback || "No se proporcion√≥ retroalimentaci√≥n adicional.";
        }
        // Mostrar enlace al PDF generado por GAS (si existe)
        try {
            const reportViewEl = document.getElementById('report-view');
            let linkEl = document.getElementById('report-gas-link');
            if (data.gasPdfUrl) {
              if (!linkEl) {
                linkEl = document.createElement('p');
                linkEl.id = 'report-gas-link';
                linkEl.style.marginTop = '8px';
                reportViewEl.appendChild(linkEl);
              }
              linkEl.innerHTML = `<a href=\"${data.gasPdfUrl}\" target=\"_blank\" rel=\"noopener\">Abrir PDF generado en Drive</a>`;
            } else if (linkEl) {
              linkEl.remove();
            }
          } catch (e) {
            console.warn('No se pudo renderizar el enlace de GAS:', e);
          }
    }
    
    // --- MODO EVALUADOR Y GESTI√ìN DE DATOS ---
    
    function renderEvaluationList() {
        const listEl = document.getElementById('case-list');
        listEl.innerHTML = '';
        if (appState.allEvaluations.length === 0) {
            listEl.innerHTML = '<p class="col-span-full text-center">No hay evaluaciones completadas para revisar.</p>';
            return;
        }
        
        appState.allEvaluations.forEach(ev => {
            const card = document.createElement('div');
            card.className = 'p-4 border rounded-lg cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-700';
            card.innerHTML = `
                <h3 class=\"font-bold\">${ev.caseTitle}</h3>
                <p class=\"text-sm\">Residente: ${ev.resident.name}</p>
                <p class=\"text-xs text-gray-500\">${new Date(ev.date).toLocaleString()}</p>
                <p class=\"text-sm font-bold mt-2 ${ev.evaluation ? 'text-green-600' : 'text-yellow-600'}\">
                    ${ev.evaluation ? 'Evaluado' : 'Pendiente de Evaluaci√≥n'}
                </p>`;
            card.onclick = () => {
                if(ev.evaluation) {
                   renderReportView(ev);
                   navigateTo('report');
                } else {
                   renderEvaluationView(ev);
                   navigateTo('evaluation');
                }
            };
            listEl.appendChild(card);
        });
    }

    function toggleTheme(isDark) {
        document.documentElement.classList.toggle('dark', isDark);
        document.getElementById('theme-toggle').textContent = isDark ? '‚òÄÔ∏è' : 'üåô';
        localStorage.setItem('theme', isDark ? 'dark' : 'light');
    }
    
    function exportData(data, filename) {
        const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        a.click();
        URL.revokeObjectURL(url);
    }
    
    function importData(fileInput, callback) {
        const file = fileInput.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const data = JSON.parse(e.target.result);
                callback(data);
            } catch (error) {
                alert("Error al leer el archivo. Aseg√∫rese de que sea un JSON v√°lido.");
            }
        };
        reader.readAsText(file);
    }
    
    function exportToCsv() {
        const ev = appState.currentResponses;
        if (!ev || !ev.evaluation) return;
        
        let csvContent = "data:text/csv;charset=utf-8,";
        csvContent += "Competencia,Peso,Puntaje,Respuesta Clave\n";
        
        CONFIG.rubrics.competencies.forEach(comp => {
            const score = ev.evaluation.scores[comp.id] || 0;
            const relevantAnswers = Object.values(ev.responses)
                .filter(r => r.competencyId === comp.id)
                .map(r => r.answer.replace(/\"/g, '""')) // Escape double quotes
                .join('; ');
            csvContent += `"${comp.name}","${comp.weight}","${score}","${relevantAnswers}"\n`;
        });
        
        const encodedUri = encodeURI(csvContent);
        const link = document.createElement("a");
        link.setAttribute("href", encodedUri);
        link.setAttribute("download", `evaluacion_${ev.resident.name}_${ev.caseId}.csv`);
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    // Utilidad simple para generar un ID √∫nico de env√≠o
function generateId() {
  return 'sub_' + Math.random().toString(36).slice(2) + Date.now().toString(36);
}

// Enviar respuestas del residente a GAS (sin calificaci√≥n)
async function sendResidentSubmissionToGAS(submission) {
  if (!GAS_URL) return { status: 'skipped' };
  const payload = {
    type: 'submission',
    id: submission.submissionId,
    date: submission.date,
    resident: submission.resident,
    caseId: submission.caseId,
    caseTitle: submission.caseTitle,
    responses: submission.responses
  };
  const res = await fetch(GAS_URL, {
    method: 'POST',
    headers: { 'Content-Type': 'text/plain;charset-utf-8' },
    body: JSON.stringify(payload)
  });
  return res.json();
}

// Obtener lista de env√≠os pendientes desde GAS
async function fetchSubmissionsFromGAS() {
  if (!GAS_URL) return null;
  try {
    const res = await fetch(GAS_URL + '?action=list');
    if (!res.ok) return null;
    const data = await res.json();
    if (Array.isArray(data.submissions)) return data.submissions;
    return null;
  } catch (e) { return null; }
}

// Enviar la evaluaci√≥n (con calificaci√≥n) a GAS a demanda desde el reporte
// Reemplazado seg√∫n solicitud del usuario
window.sendEvaluationToGAS = async function() {
    const btn = document.getElementById('send-to-gas-btn');
    const statusEl = document.getElementById('send-status');
    if (!appState.currentResponses || !appState.currentResponses.evaluation) {
        alert('Primero guarda la evaluaci√≥n para poder enviarla.');
        return;
    }
    if (!GAS_URL) {
        alert('La URL de Google Apps Script no est√° configurada.');
        return;
    }

    btn.disabled = true;
    btn.textContent = 'Enviando...';
    if (statusEl) {
        statusEl.textContent = 'Enviando al servidor...';
        statusEl.style.color = 'var(--text-secondary)';
    }

    try {
        const res = await fetch(GAS_URL, {
            method: 'POST',
            // Omitimos 'no-cors' para poder leer la respuesta
            headers: { 'Content-Type': 'text/plain;charset=utf-8' },
            body: JSON.stringify(appState.currentResponses)
        });

        const json = await res.json();

        if (json.status === 'success' && json.pdfUrl) {
            appState.currentResponses.gasPdfUrl = json.pdfUrl;
            renderReportView(appState.currentResponses);
            if (statusEl) {
                statusEl.textContent = '¬°PDF guardado en Drive!';
                statusEl.style.color = '#16a34a';
            }
            alert('Evaluaci√≥n guardada y PDF generado exitosamente en Google Drive.');
        } else {
            throw new Error(json.message || 'Respuesta no exitosa del servidor');
        }
    } catch (e) {
        if (statusEl) {
            statusEl.textContent = `Fallo al enviar: ${e.message}`;
            statusEl.style.color = 'var(--danger-color)';
        }
        alert('No se pudo enviar a Drive: ' + e.message);
    } finally {
        btn.disabled = false;
        btn.textContent = 'Generar PDF y Enviar a Drive';
    }
}

    // --- 6. EVENT LISTENERS ---
    
    function setupEventListeners() {
        document.getElementById('start-sim-btn').addEventListener('click', () => {
            const name = document.getElementById('residentName').value;
            const level = document.getElementById('residentLevel').value;
            if (name.trim() && level.trim()) {
                startSimulation(name, level);
            } else {
                alert("Por favor, complete todos los campos.");
            }
        });
        
        document.getElementById('evaluator-mode-link').addEventListener('click', () => {
            const password = prompt("Ingrese la contrase√±a de evaluador:");
            if (password === CONFIG.evaluatorPassword) {
                startEvaluation();
            } else if (password) {
                alert("Contrase√±a incorrecta.");
            }
        });

        document.getElementById('submit-responses-btn').addEventListener('click', submitResponses);
        document.getElementById('save-evaluation-btn').addEventListener('click', saveEvaluation);
        document.getElementById('back-to-welcome-btn').addEventListener('click', () => navigateTo('welcome'));
        
        document.getElementById('theme-toggle').addEventListener('click', () => {
            toggleTheme(document.documentElement.classList.toggle('dark'));
        });
        
        // Data management buttons
        document.getElementById('export-json-btn').addEventListener('click', () => exportData(appState.currentResponses, `evaluacion_${appState.currentResponses.resident.name}.json`));
        document.getElementById('export-csv-btn').addEventListener('click', exportToCsv);
        document.getElementById('export-all-btn').addEventListener('click', () => exportData(appState.allEvaluations, 'todas_las_evaluaciones.json'));
    const sendBtn = document.getElementById('send-to-gas-btn');
    if (sendBtn) sendBtn.addEventListener('click', () => window.sendEvaluationToGAS());
        
        const importCasesInput = document.getElementById('import-cases-input');
        document.getElementById('import-cases-btn').addEventListener('click', () => importCasesInput.click());
        importCasesInput.addEventListener('change', () => importData(importCasesInput, (data) => {
            if (Array.isArray(data) && data.every(c => c.id && c.title && c.questions)) {
                cases = data;
                localStorage.setItem('customCases', JSON.stringify(cases));
                alert(`${data.length} casos importados correctamente.`);
            } else {
                alert("El formato del archivo de casos es incorrecto.");
            }
        }));
        
        const importAllInput = document.getElementById('import-all-input');
        document.getElementById('import-all-btn').addEventListener('click', () => importAllInput.click());
        importAllInput.addEventListener('change', () => importData(importAllInput, (data) => {
            if (Array.isArray(data)) {
                appState.allEvaluations = data;
                localStorage.setItem('allEvaluations', JSON.stringify(appState.allEvaluations));
                alert(`${data.length} evaluaciones importadas correctamente.`);
            } else {
                alert("El formato del archivo de evaluaciones es incorrecto.");
            }
        }));
    }

    // --- 7. INICIO DE LA APP ---
    init();
});

// Handler global de errores para facilitar soporte
window.onerror = function(message, source, lineno, colno, error) {
  console.error('[UCI App] Error:', message, 'en', source, lineno + ':' + colno, error);
  alert('Ocurri√≥ un error cargando la aplicaci√≥n. Por favor, actualiza con Ctrl+F5 e intenta nuevamente.');
};
</script>

</body>
</html>